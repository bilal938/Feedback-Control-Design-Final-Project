syms V xdot xddot t tddot Lp M m g;

Kt = 7.67 * 10^-3;
Km = 7.67 * 10^-3;
Kg = 3.71;
Jm = 3.9 * 10^-7;
Rm = 2.6;
r = 6.36 * 10^-3;
m = .23;
Lp = .3302;
M = .94;
g = 9.81;


% 
% simplify((Kt*Kg/r^2/Rm)/((M+m)*Jm*Kg^2/r^2 - 3*m/4))

eq1 = Kt*Kg*V/(r*Rm) - Kt*Km*Kg^2*xdot/(r^2*Rm) - Jm*(Kg/r)^2*xddot == (M+m)*xddot + m*Lp*tddot;
eq2 = 4/3*m*Lp^2*tddot + m*Lp*xddot - m*g*Lp*t == 0;

solve([eq1, eq2], [xddot, tddot])

a_12 = 4*Kg^2*Kt*Km/(Rm*(-4*Jm*Kg^2-4*M*r^2-m*r^2));

a_23 = 3*Rm*g*m*r^2/(Rm*(-4*Jm*Kg^2-4*M*r^2-m*r^2));

a_42 = 3*Kg^2*Kt*Km/(Lp*Rm*(4*Jm*Kg^2+4*M*r^2+m*r^2));

a_43 = Rm*g*(Jm*Kg^2+M*r^2+m*r^2)/(Lp*Rm*(4*Jm*Kg^2+4*M*r^2+m*r^2));

b_2 = -4*Kg*Kt/(Rm*(-4*Jm*Kg^2-4*M*r^2-m*r^2));

b_4 = -3*r/(Lp*Rm*(4*Jm*Kg^2+4*M*r^2+m*r^2));

A = [0, 1, 0, 0;
     0, a_12, a_23, 0;
     0, 0, 0, 1;
     0, a_42, a_43, 0];
 
B = [0; b_2; 0; b_4];

C = [1, 0, 1, 0];

D = [0];

eig(A);

% eigenvalues are 
%          0
%    -7.3259
%    -1.9487
%     2.4623

%% simulation

sys = ss(A, B, C, D);
systf = tf(sys);
step(systf)
title("Step response of open-loop system");

% tf1 = ss2tf(A, B, C, D)

%% 3.3 b

syms k1 k2 k3 k4 s

K = [k1 k2 k3 k4];

Ak = A - B*K

simplify(det(s*eye(4) - Ak))

% (113943072355250841238497270777157*k3*s)/39614081257132168796771975168 - (44560532411360557646700298046305*s)/1267650600228229401496703205376 - (591838408926843557154829911038095*k2*s)/316912650057057350374175801344 - (591838408926843557154829911038095*k1)/316912650057057350374175801344 + (8423120118649171*k1*s^2)/35184372088832 + (8423120118649171*k2*s^3)/35184372088832 - (8552144421053061*k3*s^2)/70368744177664 + (113943072355250841238497270777157*k4*s^2)/39614081257132168796771975168 - (8552144421053061*k4*s^3)/70368744177664 - (2409685837397345*s^2)/281474976710656 + (3834972466563923*s^3)/562949953421312 + s^4

%% 3.3 c

expand((s-(-2-10j))*(s-(-2+10j))*(s-(-1.6-1.3j))*(s-(-1.6+1.3j)))

% Desired eq: s^4 + (36*s^3)/5 + (2421*s^2)/20 + (1749*s)/5 + 442

%% 3.3 d

s0 = -(591838408926843557154829911038095*k1)/316912650057057350374175801344 == 442;

s1 = (113943072355250841238497270777157*k3)/39614081257132168796771975168 - (44560532411360557646700298046305)/1267650600228229401496703205376 - (591838408926843557154829911038095*k2)/316912650057057350374175801344 == 1749/5;

s2 = (8423120118649171*k1)/35184372088832 - (8552144421053061*k3)/70368744177664 + (113943072355250841238497270777157*k4)/39614081257132168796771975168 == 2421/20;

s3 = (3834972466563923)/562949953421312 - (8552144421053061*k4)/70368744177664 + (8423120118649171*k2)/35184372088832 == 36/5;

solve([s0, s1, s2, s3],[k1, k2, k3, k4])

% {k1:?0.236678439946492,k2:0.0363618665124172,k3:0.157443234973144,k4:0.068436325460696}

%% 3.3 e

K = [-0.236678439946492, 0.0363618665124172, 0.157443234973144, 0.068436325460696];

Ak2 = A - B*K

% Ak2 =

%          0    1.0000         0         0
%    56.6607  -15.5173  -39.1891  -16.3836
%          0         0         0    1.0000
%   -28.7643   19.8923   27.6955    8.3173


eig(Ak2)

%   -1.8473 + 9.5638i
%   -1.8473 - 9.5638i
%   -1.7527 + 1.2596i
%   -1.7527 - 1.2596i

%% 3.4

r = [1; 0; 0; 0];
K = [-0.236678439946492, 0.0363618665124172, 0.157443234973144, 0.068436325460696];
Ak2 = A - B*K;
D2 = [1];

sys = ss2tf(Ak2, B*K*r, C, D2);

bode(sys, {1, 100})
                                                                                                                                                                                                                                                                      
